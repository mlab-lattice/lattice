#!/usr/bin/env bash

DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
BUILD_STATE_DIR=${DIR}/../../../../.state/build
mkdir -p ${BUILD_STATE_DIR}
cd ${BUILD_STATE_DIR}

mkdir -p artifacts/master-node
cd artifacts

set -o pipefail
set -e

echo "Creating kubernetes cert"
cat > kubernetes-csr.json <<EOF
{
  "CN": "kube-masters.system.internal",
  "hosts": [
    "10.32.0.1",
    "kube-masters.system.internal"
  ],
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "C": "US",
      "L": "San Francisco",
      "O": "Kubernetes",
      "OU": "Cluster",
      "ST": "California"
    }
  ]
}
EOF

cfssl gencert \
  -ca=ca.pem \
  -ca-key=ca-key.pem \
  -config=ca-config.json \
  -profile=kubernetes \
  kubernetes-csr.json | cfssljson -bare kubernetes

echo "Creating known_tokens"
ADMIN_TOKEN=$(cat admin-token)
cat > known_tokens.csv <<EOF
${ADMIN_TOKEN},admin,10001
EOF

cp kubernetes.pem kubernetes-key.pem master-node
cp kubeconfig master-node/kubeconfig
cp known_tokens.csv master-node/known_tokens.csv

echo "Creating admin localhost kubeconfig"
kubectl config set-cluster lattice --server=http://localhost:8080 --kubeconfig=admin.kubeconfig
kubectl config set-context default --cluster=lattice --kubeconfig=admin.kubeconfig
kubectl config use-context default --kubeconfig=admin.kubeconfig
cp admin.kubeconfig master-node/admin.kubeconfig
